#
# Makefile.in for ircd/src
#
# $Id: Makefile.in,v 7.150 2003/08/11 12:40:18 adx Exp $
#
@SET_MAKE@

CC		= @CC@
INSTALL		= @INSTALL@
INSTALL_BIN	= @INSTALL_PROGRAM@
INSTALL_DATA	= @INSTALL_DATA@
LEX		= @LEX@
CFLAGS		= @IRC_CFLAGS@
LDFLAGS   	= @LDFLAGS@
MKDEP		= @MKDEP@
STDOUT		= @STDOUT@
MV		= @MV@
RM		= @RM@
SED		= @SED@
YACC		= @YACC@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
sysconfdir	= @sysconfdir@
localstatedir	= @localstatedir@

# must not have whitespace here
CLOBBER=@CLOBBER@

NETIO_SRC	= s_bsd_@SELECT_TYPE@.c
INET_MISC	= @INET_MISC@

# If you wish to change this, look in include/defaults.h also and change SPATH
PROGS		= ircd

SSL_LIBS	= @SSL_LIBS@
SSL_INCLUDES	= @SSL_INCLUDES@
IRCDLIBS	= @MODULES_LIBS@ @LIBS@ $(SSL_LIBS)
INCLUDES	= -I../include $(SSL_INCLUDES)
CPPFLAGS	= ${INCLUDES} @CPPFLAGS@
 
default:	all

y.tab.o:	y.tab.c ircd_parser.y
	${CC} ${CPPFLAGS} ${CFLAGS} -I. -c y.tab.c

# Note GNU bison uses <file>.tab.c not y.tab.c
y.tab.c:	ircd_parser.y
	${YACC} -d ircd_parser.y

lex.yy.o:	y.tab.c lex.yy.c ircd_lexer.l
	${CC} ${CPPFLAGS} ${CFLAGS} -I. -c lex.yy.c

lex.yy.c:	ircd_lexer.l
	${LEX} ircd_lexer.l

SSL_SRCS = rsa.c

BASE_SRCS =	\
 channel.c \
 channel_mode.c \
 client.c \
 cluster.c \
 @CRYPT_C@ \
 dbuf.c	\
 event.c \
 fdlist.c \
 fileio.c \
 getopt.c \
 hash.c	\
 hook.c	\
 hostmask.c \
 irc_getaddrinfo.c \
 irc_getnameinfo.c \
 irc_res.c \
 irc_reslib.c \
 irc_string.c \
 ircd.c \
 ircd_signal.c \
 csvlib.c \
 list.c \
 listener.c \
 m_error.c \
 match.c \
 memory.c \
 modules.c \
 motd.c \
 numeric.c \
 packet.c \
 parse.c \
 restart.c \
 resv.c	\
 s_auth.c \
 s_bsd.c \
 s_conf.c \
 s_debug.c \
 s_gline.c \
 s_log.c \
 s_misc.c \
 s_serv.c \
 s_stats.c \
 s_user.c \
 send.c \
 sprintf_irc.c \
 @SNPRINTF_C@ \
 @BALLOC_C@ \
 @INET_MISC@ \
 @SSL_SRCS_ENABLE@ \
 @DYNLINK_C@ \
 tools.c \
 whowas.c

SRCS = ${BASE_SRCS} $(NETIO_SRC)
OBJS = ${SRCS:.c=.o}

all: .depend ircd

build: all

ircd: @MODULES_LIBS@ $(OBJS) y.tab.o lex.yy.o version.o
	${CC} ${CFLAGS} ${LDFLAGS} -o $@ ${OBJS} lex.yy.o y.tab.o version.o ${IRCDLIBS}
	${MV} -f version.c version.c.last

../modules/libmodules.a:
	cd ../modules && ${MAKE} ${MFLAGS}

install-mkdirs:
	mkdir -p $(prefix) $(exec_prefix) $(bindir) $(sysconfdir) \
		$(localstatedir)/logs 

install: install-mkdirs build
	@for i in $(PROGS); do \
		if test -f $(bindir)/$$i -a -z "$(CLOBBER)"; then \
			echo $(MV) $(bindir)/$$i $(bindir)/$$i.old; \
			$(MV) $(bindir)/$$i $(bindir)/$$i.old; \
		fi; \
		echo $(INSTALL_BIN) $$i $(bindir); \
		$(INSTALL_BIN) $$i $(bindir); \
	done

version.c: version.c.SH
	/bin/sh ./version.c.SH

# this is really the default rule for c files
.c.o:
	${CC} ${CPPFLAGS} ${CFLAGS} -c $<

.depend:
	${MKDEP} ${CPPFLAGS} ${BASE_SRCS} ${NETIO_SRC} ${STDOUT}
	@${SED} -e '/^# Autogenerated - do not delete/,$$d' <Makefile >Makefile.depend
	@echo "# Autogenerated - do not delete" >> Makefile.depend
	@echo "include .depend" >> Makefile.depend
	@${MV} Makefile.depend Makefile

clean:
	${RM} -f *.o *.exe *~ y.tab.* lex.yy.c *core ircd

distclean: clean
	${RM} -f Makefile version.c version.c.last .depend

.PHONY: clean distclean install install-mkdirs build
